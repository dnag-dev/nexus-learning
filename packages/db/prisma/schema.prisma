generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───

enum UserRole {
  PARENT
  TEACHER
  ADMIN
}

enum GradeLevel {
  K
  G1
  G2
  G3
  G4
  G5
}

enum AgeGroup {
  EARLY_5_7
  MID_8_10
  UPPER_11_12
}

enum KnowledgeDomain {
  COUNTING
  OPERATIONS
  GEOMETRY
  MEASUREMENT
  DATA
}

enum SessionState {
  IDLE
  DIAGNOSTIC
  TEACHING
  PRACTICE
  HINT_REQUESTED
  STRUGGLING
  CELEBRATING
  BOSS_CHALLENGE
  REVIEW
  EMOTIONAL_CHECK
  COMPLETED
}

enum MasteryLevel {
  NOVICE
  DEVELOPING
  PROFICIENT
  ADVANCED
  MASTERED
}

enum EmotionalState {
  ENGAGED
  FRUSTRATED
  BORED
  CONFUSED
  EXCITED
  NEUTRAL
  ANXIOUS
  BREAKTHROUGH
}

enum BossChallengeStatus {
  LOCKED
  AVAILABLE
  ACTIVE
  COMPLETED
  FAILED
}

enum BossChallengeType {
  SPEED_ROUND
  MULTI_STEP
  STORY_PROBLEM
  REAL_WORLD
}

enum SessionType {
  LEARNING
  REVIEW
  DIAGNOSTIC
  BOSS
}

enum NotificationType {
  REVIEW_DUE
  STREAK_REMINDER
  BADGE_EARNED
  LEVEL_UP
  REPORT_READY
}

enum SubscriptionPlan {
  SPARK
  PRO
  FAMILY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// ─── Models ───

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  role         UserRole      @default(PARENT)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  children     Student[]
  subscription Subscription?

  @@map("users")
}

model Student {
  id              String           @id @default(cuid())
  displayName     String
  avatarPersonaId String           @default("cosmo")
  gradeLevel      GradeLevel
  ageGroup        AgeGroup
  parentId        String
  xp              Int              @default(0)
  level           Int              @default(1)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  parent          User             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  sessions        LearningSession[]
  masteryScores   MasteryScore[]
  emotionalLogs   EmotionalLog[]
  streakData      StreakData?
  bossChallenges  BossChallenge[]
  badges          Badge[]
  notifications   Notification[]
  weeklyReports   WeeklyReport[]

  @@index([parentId])
  @@map("students")
}

model KnowledgeNode {
  id           String          @id @default(cuid())
  nodeCode     String          @unique
  title        String
  description  String
  gradeLevel   GradeLevel
  domain       KnowledgeDomain
  difficulty   Int             @default(1)
  prerequisites KnowledgeNode[] @relation("NodePrerequisites")
  successors    KnowledgeNode[] @relation("NodePrerequisites")
  masteryScores MasteryScore[]
  sessions      LearningSession[]

  @@index([gradeLevel, domain])
  @@map("knowledge_nodes")
}

model LearningSession {
  id                   String         @id @default(cuid())
  studentId            String
  sessionType          SessionType    @default(LEARNING)
  state                SessionState   @default(IDLE)
  currentNodeId        String?
  startedAt            DateTime       @default(now())
  endedAt              DateTime?
  durationSeconds      Int            @default(0)
  questionsAnswered    Int            @default(0)
  correctAnswers       Int            @default(0)
  hintsUsed            Int            @default(0)
  emotionalStateAtStart EmotionalState?
  emotionalStateAtEnd   EmotionalState?
  emotionalChecksCount  Int            @default(0)
  adaptationsTriggered  Int            @default(0)
  averageResponseTimeMs Int?
  frustrationPeakCount  Int            @default(0)
  // Review session fields
  reviewNodeIds        String[]       @default([])
  completedNodeIds     String[]       @default([])
  retentionRate        Float?
  student              Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentNode          KnowledgeNode? @relation(fields: [currentNodeId], references: [id])
  emotionalLogs        EmotionalLog[]

  @@index([studentId])
  @@index([currentNodeId])
  @@index([sessionType])
  @@map("learning_sessions")
}

model MasteryScore {
  id              String       @id @default(cuid())
  studentId       String
  nodeId          String
  level           MasteryLevel @default(NOVICE)
  bktProbability  Float        @default(0.0)
  practiceCount   Int          @default(0)
  correctCount    Int          @default(0)
  lastPracticed   DateTime     @default(now())
  nextReviewAt    DateTime?
  easinessFactor  Float        @default(2.5)
  reviewCount     Int          @default(0)
  reviewInterval  Int          @default(1) // days
  student         Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node            KnowledgeNode @relation(fields: [nodeId], references: [id])

  @@unique([studentId, nodeId])
  @@index([studentId])
  @@index([nodeId])
  @@index([nextReviewAt])
  @@map("mastery_scores")
}

model EmotionalLog {
  id                  String         @id @default(cuid())
  studentId           String
  sessionId           String
  detectedState       EmotionalState
  confidence          Float
  triggeredAdaptation Boolean        @default(false)
  adaptationType      String?        // e.g., "difficulty_decrease", "encouragement", "break_suggestion"
  signals             Json?          // Raw behavioral signals that led to detection
  timestamp           DateTime       @default(now())
  student             Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session             LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([sessionId])
  @@index([detectedState])
  @@map("emotional_logs")
}

model BehavioralSignal {
  id                    String   @id @default(cuid())
  sessionId             String
  studentId             String
  signalType            String   // "keystroke_timing", "attempt_count", "hint_usage", "response_speed", "pause_duration"
  value                 Float    // Normalized signal value
  rawData               Json?    // Raw signal data
  questionIndex         Int?     // Which question this signal relates to
  timestamp             DateTime @default(now())

  @@index([sessionId])
  @@index([studentId])
  @@index([signalType])
  @@map("behavioral_signals")
}

model StreakData {
  id              String   @id @default(cuid())
  studentId       String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActiveDate  DateTime @default(now())
  totalDaysActive Int      @default(0)
  freezesAvailable Int     @default(0)
  freezesUsed     Int      @default(0)
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("streak_data")
}

model BossChallenge {
  id             String              @id @default(cuid())
  studentId      String
  nodeIds        String[]            // mastered node IDs used to unlock
  challengeType  BossChallengeType   @default(STORY_PROBLEM)
  difficulty     Int                 @default(3)
  status         BossChallengeStatus @default(LOCKED)
  timeLimitSecs  Int                 @default(900)
  pointsReward   Int                 @default(200)
  xpReward       Int                 @default(200)
  score          Float?
  timeSpentMs    Int?
  createdAt      DateTime            @default(now())
  completedAt    DateTime?
  student        Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@map("boss_challenges")
}

model Badge {
  id          String   @id @default(cuid())
  studentId   String
  badgeType   String   // e.g., "first_star", "constellation_complete", "dragon_slayer"
  category    String   // "MASTERY", "STREAK", "SPEED", "EMOTIONAL", "BOSS"
  earnedAt    DateTime @default(now())
  displayed   Boolean  @default(false)
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeType])
  @@index([studentId])
  @@map("badges")
}

model Notification {
  id          String           @id @default(cuid())
  studentId   String
  type        NotificationType
  title       String
  message     String
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())
  expiresAt   DateTime?
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([type])
  @@index([read])
  @@map("notifications")
}

model WeeklyReport {
  id          String   @id @default(cuid())
  studentId   String
  weekStart   DateTime
  weekEnd     DateTime
  reportText  String   // Claude-generated narrative
  stats       Json     // { sessions, timeSpent, nodesMastered, accuracy, streakDays, ... }
  generatedAt DateTime @default(now())
  viewedAt    DateTime?
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, weekStart])
  @@index([studentId])
  @@index([weekStart])
  @@map("weekly_reports")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(SPARK)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime           @default(now())
  currentPeriodEnd     DateTime
  trialEndsAt          DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model WebhookLog {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  payload     Json
  processedAt DateTime @default(now())
  success     Boolean  @default(true)
  error       String?

  @@index([eventType])
  @@index([processedAt])
  @@map("webhook_logs")
}
