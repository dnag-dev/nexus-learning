generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───

enum UserRole {
  PARENT
  TEACHER
  ADMIN
}

enum GradeLevel {
  K
  G1
  G2
  G3
  G4
  G5
  G6
  G7
  G8
  G9
  G10
}

// ─── Subject (MATH or ENGLISH) ───
enum Subject {
  MATH
  ENGLISH
}

enum AgeGroup {
  EARLY_5_7
  MID_8_10
  UPPER_11_12
}

enum KnowledgeDomain {
  // Math domains
  COUNTING
  OPERATIONS
  GEOMETRY
  MEASUREMENT
  DATA
  // English Language Arts domains
  GRAMMAR
  READING
  WRITING
  VOCABULARY
}

enum SessionState {
  IDLE
  DIAGNOSTIC
  TEACHING
  PRACTICE
  HINT_REQUESTED
  STRUGGLING
  CELEBRATING
  BOSS_CHALLENGE
  REVIEW
  EMOTIONAL_CHECK
  COMPLETED
}

enum MasteryLevel {
  NOVICE
  DEVELOPING
  PROFICIENT
  ADVANCED
  MASTERED
}

enum EmotionalState {
  ENGAGED
  FRUSTRATED
  BORED
  CONFUSED
  EXCITED
  NEUTRAL
  ANXIOUS
  BREAKTHROUGH
}

enum BossChallengeStatus {
  LOCKED
  AVAILABLE
  ACTIVE
  COMPLETED
  FAILED
}

enum BossChallengeType {
  SPEED_ROUND
  MULTI_STEP
  STORY_PROBLEM
  REAL_WORLD
}

enum SessionType {
  LEARNING
  REVIEW
  DIAGNOSTIC
  BOSS
}

enum NotificationType {
  REVIEW_DUE
  STREAK_REMINDER
  BADGE_EARNED
  LEVEL_UP
  REPORT_READY
}

enum SubscriptionPlan {
  SPARK
  PRO
  FAMILY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

// ─── Phase 11: Teacher Dashboard Enums ───

enum AlertType {
  REPEATED_FAILURE
  PROLONGED_ABSENCE
  SUSTAINED_FRUSTRATION
  LOW_MASTERY_VELOCITY
  STRUGGLING_STUDENT
}

enum AlertStatus {
  ALERT_ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum AssignmentStatus {
  DRAFT
  ASSIGNMENT_ACTIVE
  ASSIGNMENT_COMPLETED
  ARCHIVED
}

// ─── Learning GPS Enums ───

enum GoalCategory {
  GRADE_PROFICIENCY
  EXAM_PREP
  SKILL_BUILDING
  CUSTOM
}

enum PlanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  ABANDONED
}

// ─── Models ───

model User {
  id             String          @id @default(cuid())
  email          String          @unique
  passwordHash   String
  role           UserRole        @default(PARENT)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  children       Student[]
  subscription   Subscription?
  teacherProfile TeacherProfile?

  @@map("users")
}

model Student {
  id              String           @id @default(cuid())
  displayName     String
  avatarPersonaId String           @default("cosmo")
  gradeLevel      GradeLevel
  ageGroup        AgeGroup
  parentId        String
  xp              Int              @default(0)
  level           Int              @default(1)
  username        String?          @unique
  pinHash         String?
  lastLoginAt     DateTime?
  // ─── Blueprint: Learning focus set by teacher/parent/kid ───
  blueprintText      String?
  blueprintNodes     String[]       @default([])
  blueprintSource    String?        // "KID", "PARENT", "TEACHER"
  blueprintUpdatedAt DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  parent          User             @relation(fields: [parentId], references: [id], onDelete: Cascade)
  sessions        LearningSession[]
  masteryScores   MasteryScore[]
  emotionalLogs   EmotionalLog[]
  streakData      StreakData?
  bossChallenges  BossChallenge[]
  badges          Badge[]
  notifications         Notification[]
  weeklyReports         WeeklyReport[]
  classEnrollments      ClassStudent[]
  assignmentSubmissions AssignmentSubmission[]
  interventionAlerts    InterventionAlert[]
  questionResponses     QuestionResponse[]
  branchUnlocks         BranchUnlock[]
  learningPlans         LearningPlan[]

  @@index([parentId])
  @@map("students")
}

model KnowledgeNode {
  id           String          @id @default(cuid())
  nodeCode     String          @unique
  title        String
  description  String
  gradeLevel   GradeLevel
  domain       KnowledgeDomain
  subject      Subject         @default(MATH)
  difficulty   Int             @default(1)
  prerequisites KnowledgeNode[] @relation("NodePrerequisites")
  successors    KnowledgeNode[] @relation("NodePrerequisites")
  masteryScores      MasteryScore[]
  sessions           LearningSession[]
  questionResponses  QuestionResponse[]

  @@index([gradeLevel, domain])
  @@index([subject])
  @@map("knowledge_nodes")
}

model LearningSession {
  id                   String         @id @default(cuid())
  studentId            String
  sessionType          SessionType    @default(LEARNING)
  subject              Subject        @default(MATH)
  state                SessionState   @default(IDLE)
  currentNodeId        String?
  startedAt            DateTime       @default(now())
  endedAt              DateTime?
  durationSeconds      Int            @default(0)
  questionsAnswered    Int            @default(0)
  correctAnswers       Int            @default(0)
  hintsUsed            Int            @default(0)
  emotionalStateAtStart EmotionalState?
  emotionalStateAtEnd   EmotionalState?
  emotionalChecksCount  Int            @default(0)
  adaptationsTriggered  Int            @default(0)
  averageResponseTimeMs Int?
  frustrationPeakCount  Int            @default(0)
  // 5-step learning loop tracking (teach → check → guided → independent → mastery proof)
  learningStep         Int            @default(1)  // 1=teach, 2=check, 3=guided, 4=independent, 5=mastery
  stepCorrectCount     Int            @default(0)  // correct answers in current step
  stepTotalCount       Int            @default(0)  // total answers in current step
  // 3-Engine: session mode
  mode                 String         @default("standard") // "standard" | "fluency" | "challenge"
  // Learning Plan linkage (Step 12: Multiple Goals)
  planId               String?        // links session to a specific learning plan
  // Review session fields
  reviewNodeIds        String[]       @default([])
  completedNodeIds     String[]       @default([])
  retentionRate        Float?
  student              Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentNode          KnowledgeNode? @relation(fields: [currentNodeId], references: [id])
  emotionalLogs        EmotionalLog[]
  questionResponses    QuestionResponse[]

  @@index([studentId])
  @@index([currentNodeId])
  @@index([planId])
  @@index([sessionType])
  @@map("learning_sessions")
}

model MasteryScore {
  id              String       @id @default(cuid())
  studentId       String
  nodeId          String
  level           MasteryLevel @default(NOVICE)
  bktProbability  Float        @default(0.0)
  practiceCount   Int          @default(0)
  correctCount    Int          @default(0)
  lastPracticed   DateTime     @default(now())
  nextReviewAt    DateTime?
  easinessFactor  Float        @default(2.5)
  reviewCount     Int          @default(0)
  reviewInterval  Int          @default(1) // days
  // ─── 3-Engine: True Mastery + Nexus Score + Fluency ───
  nexusScore         Float    @default(0)     // composite 0-100
  speedTrendMs       Float?                   // rolling avg response time
  retentionScore     Float    @default(0)     // 0-1, from spaced repetition checks
  trulyMastered      Boolean  @default(false) // all 4 criteria met
  fluencyDrillMode   Boolean  @default(false) // currently in fluency drill
  personalBestMs     Int?                     // fastest correct response time
  consecutiveCorrect Int      @default(0)     // for fluency: 10 consecutive at benchmark
  student         Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node            KnowledgeNode @relation(fields: [nodeId], references: [id])

  @@unique([studentId, nodeId])
  @@index([studentId])
  @@index([nodeId])
  @@index([nextReviewAt])
  @@map("mastery_scores")
}

model EmotionalLog {
  id                  String         @id @default(cuid())
  studentId           String
  sessionId           String
  detectedState       EmotionalState
  confidence          Float
  triggeredAdaptation Boolean        @default(false)
  adaptationType      String?        // e.g., "difficulty_decrease", "encouragement", "break_suggestion"
  signals             Json?          // Raw behavioral signals that led to detection
  timestamp           DateTime       @default(now())
  student             Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  session             LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([sessionId])
  @@index([detectedState])
  @@map("emotional_logs")
}

model BehavioralSignal {
  id                    String   @id @default(cuid())
  sessionId             String
  studentId             String
  signalType            String   // "keystroke_timing", "attempt_count", "hint_usage", "response_speed", "pause_duration"
  value                 Float    // Normalized signal value
  rawData               Json?    // Raw signal data
  questionIndex         Int?     // Which question this signal relates to
  timestamp             DateTime @default(now())

  @@index([sessionId])
  @@index([studentId])
  @@index([signalType])
  @@map("behavioral_signals")
}

model StreakData {
  id              String   @id @default(cuid())
  studentId       String   @unique
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActiveDate  DateTime @default(now())
  totalDaysActive Int      @default(0)
  freezesAvailable Int     @default(0)
  freezesUsed     Int      @default(0)
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("streak_data")
}

model BossChallenge {
  id             String              @id @default(cuid())
  studentId      String
  nodeIds        String[]            // mastered node IDs used to unlock
  challengeType  BossChallengeType   @default(STORY_PROBLEM)
  difficulty     Int                 @default(3)
  status         BossChallengeStatus @default(LOCKED)
  timeLimitSecs  Int                 @default(900)
  pointsReward   Int                 @default(200)
  xpReward       Int                 @default(200)
  score          Float?
  timeSpentMs    Int?
  createdAt      DateTime            @default(now())
  completedAt    DateTime?
  student        Student             @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([status])
  @@map("boss_challenges")
}

model Badge {
  id          String   @id @default(cuid())
  studentId   String
  badgeType   String   // e.g., "first_star", "constellation_complete", "dragon_slayer"
  category    String   // "MASTERY", "STREAK", "SPEED", "EMOTIONAL", "BOSS"
  earnedAt    DateTime @default(now())
  displayed   Boolean  @default(false)
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, badgeType])
  @@index([studentId])
  @@map("badges")
}

model Notification {
  id          String           @id @default(cuid())
  studentId   String
  type        NotificationType
  title       String
  message     String
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())
  expiresAt   DateTime?
  student     Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([type])
  @@index([read])
  @@map("notifications")
}

model WeeklyReport {
  id          String   @id @default(cuid())
  studentId   String
  weekStart   DateTime
  weekEnd     DateTime
  reportText  String   // Claude-generated narrative
  stats       Json     // { sessions, timeSpent, nodesMastered, accuracy, streakDays, ... }
  generatedAt DateTime @default(now())
  viewedAt    DateTime?
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, weekStart])
  @@index([studentId])
  @@index([weekStart])
  @@map("weekly_reports")
}

model Subscription {
  id                   String             @id @default(cuid())
  userId               String             @unique
  plan                 SubscriptionPlan   @default(SPARK)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  status               SubscriptionStatus @default(ACTIVE)
  currentPeriodStart   DateTime           @default(now())
  currentPeriodEnd     DateTime
  trialEndsAt          DateTime?
  cancelAtPeriodEnd    Boolean            @default(false)
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model WebhookLog {
  id          String   @id @default(cuid())
  eventId     String   @unique
  eventType   String
  payload     Json
  processedAt DateTime @default(now())
  success     Boolean  @default(true)
  error       String?

  @@index([eventType])
  @@index([processedAt])
  @@map("webhook_logs")
}

// ─── 3-Engine: Question Response Tracking ───

model QuestionResponse {
  id             String          @id @default(cuid())
  studentId      String
  nodeId         String
  sessionId      String
  questionText   String
  isCorrect      Boolean
  responseTimeMs Int             // milliseconds to answer
  questionType   String          // check_understanding, guided_practice, etc.
  createdAt      DateTime        @default(now())

  student        Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  node           KnowledgeNode   @relation(fields: [nodeId], references: [id])
  session        LearningSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([studentId, nodeId, createdAt])
  @@index([studentId, nodeId, questionType])
  @@map("question_responses")
}

model FluencyBenchmark {
  id          String  @id @default(cuid())
  domain      String  // ADDITION, MULTIPLICATION, GRAMMAR, etc.
  gradeLevel  String  // K, 1, 2, 3...
  targetTimeMs Int    // target response time in ms
  description String?

  @@unique([domain, gradeLevel])
  @@map("fluency_benchmarks")
}

model TopicBranch {
  id                    String   @id @default(cuid())
  name                  String   // "Multiplication Mastery", "Fraction Explorer"
  description           String
  domain                String
  gradeLevel            String
  nodeIds               String[] // ordered list of KnowledgeNode IDs in this branch
  prerequisiteBranchIds String[] // branches that must be completed first
  isAdvanced            Boolean  @default(false)
  sortOrder             Int      @default(0)

  unlocks               BranchUnlock[]

  @@map("topic_branches")
}

model BranchUnlock {
  id             String    @id @default(cuid())
  studentId      String
  branchId       String
  unlockedAt     DateTime  @default(now())
  completedAt    DateTime?
  nodesCompleted Int       @default(0)
  totalNodes     Int

  student        Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  branch         TopicBranch @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([studentId, branchId])
  @@index([studentId])
  @@map("branch_unlocks")
}

// ─── Phase 11: Teacher Dashboard Models ───

model School {
  id        String           @id @default(cuid())
  name      String
  district  String?
  createdAt DateTime         @default(now())
  teachers  TeacherProfile[]

  @@map("schools")
}

model TeacherProfile {
  id        String             @id @default(cuid())
  userId    String             @unique
  schoolId  String?
  createdAt DateTime           @default(now())
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  school    School?            @relation(fields: [schoolId], references: [id])
  classes   Class[]
  alerts    InterventionAlert[]

  @@index([schoolId])
  @@map("teacher_profiles")
}

model Class {
  id          String         @id @default(cuid())
  name        String
  gradeLevel  GradeLevel
  teacherId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  students    ClassStudent[]
  assignments Assignment[]

  @@index([teacherId])
  @@map("classes")
}

model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  joinedAt  DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@map("class_students")
}

model Assignment {
  id          String              @id @default(cuid())
  classId     String
  title       String
  description String?
  nodeIds     String[]
  status      AssignmentStatus    @default(DRAFT)
  dueDate     DateTime?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  class       Class               @relation(fields: [classId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmission[]

  @@index([classId])
  @@index([status])
  @@map("assignments")
}

model AssignmentSubmission {
  id             String     @id @default(cuid())
  assignmentId   String
  studentId      String
  nodesAttempted String[]
  nodesMastered  String[]
  score          Float?
  completedAt    DateTime?
  assignment     Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student        Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@map("assignment_submissions")
}

model InterventionAlert {
  id          String         @id @default(cuid())
  teacherId   String
  studentId   String
  alertType   AlertType
  status      AlertStatus    @default(ALERT_ACTIVE)
  title       String
  description String
  data        Json?
  createdAt   DateTime       @default(now())
  resolvedAt  DateTime?
  teacher     TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  student     Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([studentId])
  @@index([status])
  @@map("intervention_alerts")
}

// ─── Learning GPS Models ───

model LearningGoal {
  id                String        @id @default(cuid())
  name              String
  description       String
  category          GoalCategory
  gradeLevel        Int?
  examType          String?
  standardsCovered  String[]
  requiredNodeIds   String[]
  estimatedHours    Float
  createdAt         DateTime      @default(now())
  learningPlans     LearningPlan[]

  @@map("learning_goals")
}

model LearningPlan {
  id                      String           @id @default(cuid())
  studentId               String
  student                 Student          @relation(fields: [studentId], references: [id])
  goalId                  String
  goal                    LearningGoal     @relation(fields: [goalId], references: [id])
  status                  PlanStatus       @default(ACTIVE)
  conceptSequence         String[]
  totalEstimatedHours     Float
  hoursCompleted          Float            @default(0)
  projectedCompletionDate DateTime
  targetCompletionDate    DateTime?
  weeklyMilestones        Json
  currentConceptIndex     Int              @default(0)
  velocityHoursPerWeek    Float            @default(0)
  isAheadOfSchedule       Boolean          @default(true)
  lastRecalculatedAt      DateTime         @default(now())
  createdAt               DateTime         @default(now())
  etaHistory              ETASnapshot[]
  milestoneResults        MilestoneResult[]

  @@index([studentId])
  @@index([goalId])
  @@index([status])
  @@map("learning_plans")
}

model ETASnapshot {
  id                      String       @id @default(cuid())
  planId                  String
  plan                    LearningPlan @relation(fields: [planId], references: [id])
  hoursRemaining          Float
  projectedCompletion     DateTime
  velocityAtSnapshot      Float
  conceptsRemaining       Int
  conceptsMastered        Int          @default(0)
  isAheadOfSchedule       Boolean      @default(true)
  daysDifference          Int          @default(0)
  insight                 String?
  triggeredBySessionId    String?
  recordedAt              DateTime     @default(now())

  @@index([planId])
  @@index([recordedAt])
  @@map("eta_snapshots")
}

model MilestoneResult {
  id             String       @id @default(cuid())
  planId         String
  plan           LearningPlan @relation(fields: [planId], references: [id])
  weekNumber     Int
  passed         Boolean
  score          Float
  conceptsTested String[]
  completedAt    DateTime     @default(now())

  @@index([planId])
  @@map("milestone_results")
}

model StandardsMapping {
  id            String   @id @default(cuid())
  standardId    String   @unique
  standardCode  String
  description   String
  subject       String
  gradeLevel    Int
  category      String
  nodeIds       String[]
  examType      String?

  @@index([subject, gradeLevel])
  @@map("standards_mappings")
}
